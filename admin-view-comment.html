<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Comment | EveryAI Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script async crossorigin="anonymous"
        data-clerk-publishable-key="pk_live_Y2xlcmsuZXZlcnktYWkuY29tJA"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js" type="text/javascript"></script>
    <style>
        .admin-page {
            padding: 120px 20px 60px;
            min-height: 100vh;
            background: var(--bg-base);
        }

        .admin-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .message-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 40px;
            box-shadow: var(--shadow-md);
        }

        .message-header {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .message-header h1 {
            font-family: var(--font-head);
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .message-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .meta-label {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 80px;
        }

        .message-content {
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            font-size: 1.1rem;
            margin-bottom: 40px;
        }

        /* ── Reply Section ── */
        .reply-section {
            margin-top: 32px;
            padding: 28px;
            background: var(--bg-base);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }

        .reply-section h3 {
            font-family: var(--font-head);
            font-size: 1.2rem;
            margin-bottom: 16px;
            color: var(--text-primary);
        }

        .reply-textarea {
            width: 100%;
            padding: 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-surface);
            color: var(--text-primary);
            resize: vertical;
            min-height: 130px;
            font-family: var(--font-sans);
            font-size: 0.95rem;
            line-height: 1.6;
            box-sizing: border-box;
        }

        .reply-textarea:focus {
            outline: none;
            border-color: var(--accent-1);
        }

        /* ── Existing reply block ── */
        .existing-reply {
            margin-top: 20px;
            padding: 18px;
            background: rgba(92, 184, 92, 0.07);
            border-left: 3px solid var(--accent-1);
            border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
        }

        .existing-reply strong {
            font-size: 0.75rem;
            color: var(--accent-1);
            display: block;
            margin-bottom: 6px;
            letter-spacing: 0.08em;
        }

        .existing-reply p {
            margin: 0;
            color: var(--text-secondary);
            white-space: pre-wrap;
            line-height: 1.7;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 32px;
            margin-top: 32px;
            border-top: 1px solid var(--border);
        }

        .btn-group {
            display: flex;
            gap: 12px;
        }

        .btn-action {
            padding: 12px 24px;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-reply-send {
            background: var(--accent-1);
            color: white;
        }

        .btn-reply-send:hover {
            filter: brightness(1.1);
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-delete:hover {
            background: #ef4444;
            color: white;
        }

        /* ── Loader ── */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 100px 0;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--accent-1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <link rel="icon" type="image/png"
        href="https://res.cloudinary.com/dhar8ajns/image/upload/v1772261620/b6e4b2aa-4284-4a0d-9603-4bae72ffb715_gq7kqd.png">
</head>

<body id="body">
    <!-- Auth Overlay -->
    <div id="admin-auth-overlay"
        style="display:none; position:fixed; inset:0; background:var(--bg-base); z-index:500; align-items:center; justify-content:center; backdrop-filter:blur(8px);">
        <div style="position:relative; z-index:501;">
            <div id="clerk-sign-in"></div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar" id="navbar">
        <div class="nav-inner">
            <a href="index.html" class="logo">
                <span class="logo-icon"><img
                        src="https://res.cloudinary.com/dhar8ajns/image/upload/v1772261620/b6e4b2aa-4284-4a0d-9603-4bae72ffb715_gq7kqd.png"
                        alt="EveryAI Logo" class="logo-img"></span>
                <span class="logo-text">Every<span class="logo-accent">AI</span> <span
                        style="font-size:0.7rem; opacity:0.5; margin-left:4px">ADMIN</span></span>
            </a>

            <ul class="nav-links">
                <li><a href="admin.html" class="nav-link">Dashboard</a></li>
                <li><a href="admin-blogs.html" class="nav-link">Blogs</a></li>
                <li><a href="admin-prompts.html" class="nav-link">Prompts</a></li>
                <li><a href="admin-support.html" class="nav-link">Support<span class="msg-badge" id="msg-badge"
                            style="display:none">0</span></a></li>
            </ul>

            <div class="nav-actions">
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="theme-toggle"><input type="checkbox" id="theme-toggle" />
                        <div class="slider-round">
                            <div class="knob"></div>
                        </div>
                    </label>
                </div>
                <div id="clerk-admin-user-button"></div>
            </div>
        </div>
    </nav>

    <main class="admin-page">
        <div class="admin-container">
            <div id="loading-view" class="loading-state">
                <div class="spinner"></div>
                <p>Loading comment...</p>
            </div>

            <div id="comment-view" style="display:none;">
                <div class="message-card">
                    <div class="message-header">
                        <h1 id="cmt-name">Comment</h1>
                        <div class="message-meta">
                            <div class="meta-item">
                                <span class="meta-label">Email:</span>
                                <span id="cmt-email"></span>
                            </div>
                            <div class="meta-item" id="cmt-website-row" style="display:none;">
                                <span class="meta-label">Website:</span>
                                <a id="cmt-website" href="#" target="_blank" style="color:var(--accent-1);"></a>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Blog:</span>
                                <span id="cmt-blog"></span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Date:</span>
                                <span id="cmt-date"></span>
                            </div>
                        </div>
                    </div>

                    <div class="message-content" id="cmt-body"></div>

                    <!-- Existing reply (shown if already replied) -->
                    <div id="existing-reply-block" class="existing-reply" style="display:none;">
                        <strong>YOUR PREVIOUS REPLY</strong>
                        <p id="existing-reply-text"></p>
                    </div>

                    <div class="action-bar">
                        <a href="admin-support.html" class="btn-action btn-back">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7" />
                            </svg>
                            Back to Support
                        </a>
                        <div class="btn-group">
                            <button class="btn-action btn-delete" id="delete-btn" onclick="deleteThisComment()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
                                </svg>
                                Delete Comment
                            </button>
                            <a id="reply-email-btn" href="#" class="btn-action btn-reply-send">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                    <polyline points="22,6 12,13 2,6" />
                                </svg>
                                Reply via Email
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="admin-toast" id="admin-toast"></div>

    <script type="module">
        import { convex } from './convex-client.js';
        import { startBadgePolling } from './admin-badge.js';

        const $ = id => document.getElementById(id);
        const AUTHORIZED_EMAILS = ['tradephani@gmail.com', 'everyai.com@gmail.com'];
        let currentId = null;

        // ── Auth ──────────────────────────────────────────────────────
        async function initAuth() {
            if (!window.Clerk) { setTimeout(initAuth, 100); return; }
            await window.Clerk.load();
            if (window.Clerk.user) {
                const email = window.Clerk.user.primaryEmailAddress.emailAddress.toLowerCase();
                if (!AUTHORIZED_EMAILS.includes(email)) { window.location.href = 'index.html'; return; }
                mountUserButton();
                startBadgePolling(convex);
                loadComment();
            } else {
                $('admin-auth-overlay').style.display = 'flex';
                window.Clerk.mountSignIn($('clerk-sign-in'), { fallbackRedirectUrl: window.location.href });
            }
        }

        function mountUserButton() {
            const div = $('clerk-admin-user-button');
            if (!div) return;
            window.Clerk.mountUserButton(div, {
                afterSignOutUrl: '/index.html',
                appearance: { elements: { userButtonPopoverActionButton__manageAccount: { display: 'none' }, userButtonAvatarBox: { width: '32px', height: '32px' } } }
            });
        }

        // ── Load Comment ──────────────────────────────────────────────
        async function loadComment() {
            const params = new URLSearchParams(window.location.search);
            currentId = params.get('id');
            if (!currentId) { window.location.href = 'admin-support.html'; return; }

            try {
                const c = await convex.query('comments:getComment', { id: currentId });
                if (!c) { window.location.href = 'admin-support.html'; return; }

                $('cmt-name').textContent = c.name;
                $('cmt-email').textContent = c.email;
                $('cmt-blog').textContent = c.blogTitle || c.blogSlug || '—';
                $('cmt-date').textContent = new Date(c.timestamp).toLocaleString();
                $('cmt-body').textContent = c.comment;

                if (c.website) {
                    $('cmt-website-row').style.display = 'flex';
                    $('cmt-website').textContent = c.website;
                    $('cmt-website').href = c.website.startsWith('http') ? c.website : 'https://' + c.website;
                }

                if (c.adminReply) {
                    $('existing-reply-block').style.display = 'block';
                    $('existing-reply-text').textContent = c.adminReply;
                }

                // Wire Reply via Email button
                const subject = encodeURIComponent(`Re: Your comment on "${c.blogTitle || c.blogSlug || 'our blog'}"`);
                const body = encodeURIComponent(`Hi ${c.name},\n\nThank you for your comment:\n"${c.comment}"\n\n`);
                $('reply-email-btn').href = `mailto:${c.email}?subject=${subject}&body=${body}`;

                $('loading-view').style.display = 'none';
                $('comment-view').style.display = 'block';
            } catch (err) {
                console.error('Failed to load comment:', err);
                window.location.href = 'admin-support.html';
            }
        }

        // ── Delete ────────────────────────────────────────────────────
        window.deleteThisComment = async () => {
            if (!confirm('Delete this comment permanently?')) return;
            try {
                await convex.mutation('comments:deleteComment', { id: currentId });
                window.location.href = 'admin-support.html';
            } catch (err) { showToast('Failed to delete: ' + err.message, 'error'); }
        };

        // ── Toast ─────────────────────────────────────────────────────
        function showToast(msg, type = 'success') {
            const t = $('admin-toast');
            if (!t) return;
            t.textContent = msg;
            t.className = `admin-toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3500);
        }

        // ── Theme & Helpers ───────────────────────────────────────────
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.add('light');
            const tt = $('theme-toggle'); if (tt) tt.checked = true;
        }
        $('theme-toggle')?.addEventListener('change', () => {
            document.body.classList.toggle('light');
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
        });
        window.addEventListener('scroll', () => {
            $('navbar')?.classList.toggle('scrolled', window.scrollY > 20);
        }, { passive: true });

        initAuth();
    </script>
</body>

</html>